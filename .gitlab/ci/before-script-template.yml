default:
  before_script:
    - top -l 1 | grep -E "^CPU|^Phys|^Load|^MemRegions"
    - date
    - echo "${CI_JOB_ID}"
    - echo "Application logs will be at ${HOME}/Library/Containers/co.beamapp.macos/Data/Library/Logs/Beam/*.log"
    - echo "${PATH}"
    - pwd
    - unset cd
    - direnv allow
    - eval "$(direnv export bash)"
    - eval "$(rbenv init -)"
    - scripts/delete-pipeline.sh
    - scripts/install_xcode.sh
    - bundle install
    # This is actually to be done once per CI or ~/.gitconfig gets messed up
    # - git config --global url."https://${GITLAB_USERNAME}:${GITLAB_ACCESS_TOKEN}@gitlab.com/".insteadOf "git@gitlab.com:"
    - scripts/move_libgit2_step1.sh
    - scripts/move_libgit2_step2.sh
    # So that we can push tags
    - git config user.email "${GITLAB_USER_EMAIL}"
    - git config user.name "${GITLAB_USER_NAME}"
    - url_host=$(echo "${CI_REPOSITORY_URL}" | sed -re "s|https?://gitlab-ci-token:.*@|https://${GITLAB_BOT_USERNAME}:${GITLAB_BOT_ACCESS_TOKEN}@|g")
    - git remote set-url --push origin "${url_host}"
